;; gorilla-repl.fileformat = 1

;; @@
(ns anglican-demo
  (:require [gorilla-plot.core :as plot])
  (:use [anglican core emit runtime stat]
        clojure.repl))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-nil'>nil</span>","value":"nil"}
;; <=

;; @@
(defquery one-flip [outcome]
  (let [bias (sample (uniform-continuous 0.0 1.0))]
    (observe (flip bias) outcome)
    bias))

(def samples 
  (doquery :rmh one-flip [true]))

(first samples)
;; @@
;; =>
;;; {"type":"list-like","open":"<span class='clj-map'>{</span>","close":"<span class='clj-map'>}</span>","separator":", ","items":[{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:log-weight</span>","value":":log-weight"},{"type":"html","content":"<span class='clj-double'>0.0</span>","value":"0.0"}],"value":"[:log-weight 0.0]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:result</span>","value":":result"},{"type":"html","content":"<span class='clj-double'>0.11315253583908103</span>","value":"0.11315253583908103"}],"value":"[:result 0.11315253583908103]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:predicts</span>","value":":predicts"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[],"value":"[]"}],"value":"[:predicts []]"}],"value":"{:log-weight 0.0, :result 0.11315253583908103, :predicts []}"}
;; <=

;; @@
(defquery one-flip [outcome]
  (let [bias (sample (uniform-continuous 0.0 1.0))]
    (observe (flip bias) outcome)
    bias))

(def samples 
  (doquery :rmh one-flip [true]))

(mean (take 1000 (map :result samples)))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-double'>0.6410969772352126</span>","value":"0.6410969772352126"}
;; <=

;; @@
(defquery one-flip []
  (let [bias (sample (uniform-continuous 0.0 1.0))]
    bias))

(def samples 
  (doquery :rmh one-flip [true]))

(mean (take 1000 (map :result samples)))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-double'>0.5076460338891972</span>","value":"0.5076460338891972"}
;; <=

;; @@
(defquery one-flip [outcome]
  (let [bias (sample (uniform-continuous 0.0 1.0))]
    (predict :outcome outcome)
    (predict :bias bias)
    (observe (flip bias) outcome)))

(def samples 
  (doquery :rmh one-flip [true]))

(require '[anglican.state :refer [get-predicts]])
(into {} (:predicts (first samples)))
;; @@
;; =>
;;; {"type":"list-like","open":"<span class='clj-map'>{</span>","close":"<span class='clj-map'>}</span>","separator":", ","items":[{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:outcome</span>","value":":outcome"},{"type":"html","content":"<span class='clj-unkown'>true</span>","value":"true"}],"value":"[:outcome true]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:bias</span>","value":":bias"},{"type":"html","content":"<span class='clj-double'>0.04237783974540643</span>","value":"0.04237783974540643"}],"value":"[:bias 0.04237783974540643]"}],"value":"{:outcome true, :bias 0.04237783974540643}"}
;; <=

;; @@
(defquery one-flip [outcome]
  (let [bias (sample (uniform-continuous 0.0 1.0))]
    (observe (flip bias) outcome)
    bias))

(def samples 
  (doquery :importance one-flip [true]))

;;(map :log-weight (take 10 samples))

;;(mean (map :result (take 1000 samples)))

;;(map :result     (take 2 samples))
;;(map :log-weight (take 2 samples))
;;(collect-results (take 2 samples))

(empirical-mean 
  (collect-results 
    (take 1000 samples)))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-double'>0.6757004947055705</span>","value":"0.6757004947055705"}
;; <=

;; @@
(defquery one-flip [outcome]
  (let [bias (sample (uniform-continuous 0.0 1.0))]
    (predict :bias bias)
    (observe (flip bias) outcome)
    (sample (flip bias))))

(def samples 
  (doquery :importance one-flip [true]))

(empirical-distribution 
  (collect-results 
    (take 1000 samples)))

(empirical-mean 
  (collect-predicts
    :bias
    (take 1000 samples)))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-double'>0.6786000505979761</span>","value":"0.6786000505979761"}
;; <=

;; @@
(defn simulate-data 
  [num-days]
  (let [days (range 1 num-days)
        yearly-growth (sample* (normal 0.03 0.03))
        daily-growth (/ yearly-growth 365)
        volatility-dist (normal 1.0 (/ 0.1 365))
        returns (reduce 
                  (fn [gs _]
                    (conj gs
                          (* (peek gs)
                             (+ 1.0 daily-growth)
                             (sample* volatility-dist))))
                  [1.0]
                  days)]
    {:days days 
     :returns returns 
     :yearly-growth yearly-growth}))

(def data (simulate-data 365))

(plot/list-plot (zipmap (:days data) 
                        (:returns data)))
;; @@
;; =>
;;; {"type":"vega","content":{"width":400,"height":247.2187957763672,"padding":{"top":10,"left":55,"bottom":40,"right":10},"data":[{"name":"0fb9d789-0807-4e7b-bd12-0482c7f41dcf","values":[{"x":357,"y":1.0136907423120647},{"x":275,"y":1.0109739388893546},{"x":291,"y":1.012247192269331},{"x":249,"y":1.011470039603879},{"x":299,"y":1.0125176443565784},{"x":121,"y":1.0090845440190959},{"x":287,"y":1.0117767812158285},{"x":65,"y":1.0035384338216526},{"x":70,"y":1.0045044917524417},{"x":218,"y":1.0118911326014375},{"x":62,"y":1.0033677256823594},{"x":74,"y":1.0049327483522588},{"x":164,"y":1.0105253146113304},{"x":282,"y":1.0124991541327375},{"x":273,"y":1.0109683894428407},{"x":186,"y":1.0121499108779688},{"x":233,"y":1.0112977119207571},{"x":298,"y":1.0125680516294584},{"x":188,"y":1.012298645151612},{"x":240,"y":1.0127075951425013},{"x":110,"y":1.0062681658297592},{"x":130,"y":1.0085532731626599},{"x":311,"y":1.0128606903426431},{"x":128,"y":1.0088951016338485},{"x":259,"y":1.011553909273812},{"x":210,"y":1.013014958893747},{"x":229,"y":1.0112707062257367},{"x":153,"y":1.010430226772156},{"x":213,"y":1.0129679536236516},{"x":343,"y":1.0145187750849696},{"x":7,"y":1.0009797236341575},{"x":59,"y":1.003045964477863},{"x":86,"y":1.0052930955595323},{"x":154,"y":1.0109237794701857},{"x":20,"y":1.0011160087028748},{"x":224,"y":1.0122206357551566},{"x":355,"y":1.0136042902454512},{"x":72,"y":1.0046601021816983},{"x":58,"y":1.0035524236683415},{"x":205,"y":1.0128765306274987},{"x":60,"y":1.0029844084543824},{"x":175,"y":1.0114079032864252},{"x":322,"y":1.0125993323085456},{"x":27,"y":1.0008877113784558},{"x":352,"y":1.013329528722753},{"x":1,"y":1.0},{"x":69,"y":1.004065910362867},{"x":101,"y":1.0066972096014213},{"x":24,"y":1.0008041319869407},{"x":102,"y":1.0067665751609347},{"x":135,"y":1.0096504696163675},{"x":354,"y":1.0132099472220142},{"x":360,"y":1.0138842841583016},{"x":55,"y":1.0031533387700833},{"x":269,"y":1.0102718603305723},{"x":206,"y":1.012975206006562},{"x":165,"y":1.0106151080357257},{"x":85,"y":1.0050753073101248},{"x":225,"y":1.0121642694520925},{"x":297,"y":1.0125959586708653},{"x":39,"y":1.0018379982185657},{"x":274,"y":1.0112505756077752},{"x":88,"y":1.0053834001523712},{"x":217,"y":1.011763748603023},{"x":46,"y":1.0020440692042396},{"x":149,"y":1.0095689166121349},{"x":239,"y":1.0124295500771876},{"x":157,"y":1.0110774233223854},{"x":345,"y":1.0137108160713786},{"x":300,"y":1.0123482892440585},{"x":4,"y":1.0005092270985778},{"x":204,"y":1.0127852125885566},{"x":77,"y":1.0049705275701424},{"x":106,"y":1.006318796303561},{"x":197,"y":1.0122315225072187},{"x":232,"y":1.0119345847462173},{"x":260,"y":1.01133603217036},{"x":267,"y":1.0107452924723312},{"x":119,"y":1.008312611885723},{"x":319,"y":1.0117878732654293},{"x":222,"y":1.0124923185165249},{"x":293,"y":1.0119955435543366},{"x":95,"y":1.0061931960729298},{"x":329,"y":1.0140989507521831},{"x":144,"y":1.0097039109139245},{"x":176,"y":1.011526295253916},{"x":349,"y":1.0130819921201866},{"x":192,"y":1.0120883295002254},{"x":54,"y":1.0028830663249202},{"x":92,"y":1.005560173925204},{"x":221,"y":1.0123102551807606},{"x":141,"y":1.0094777222868367},{"x":307,"y":1.0124332617355654},{"x":290,"y":1.0120255111431875},{"x":361,"y":1.013868727626491},{"x":264,"y":1.0108306285167414},{"x":137,"y":1.0096334609844997},{"x":356,"y":1.0140926582017333},{"x":327,"y":1.0134011989983716},{"x":234,"y":1.011642780194859},{"x":104,"y":1.0063803256994979},{"x":353,"y":1.013243871101066},{"x":15,"y":1.001537325336652},{"x":48,"y":1.0017554332461296},{"x":242,"y":1.0125174401990946},{"x":50,"y":1.0025375485865624},{"x":251,"y":1.0117134121643645},{"x":116,"y":1.0076881330214165},{"x":75,"y":1.0049013629911674},{"x":159,"y":1.011536902451242},{"x":99,"y":1.0063918245416845},{"x":281,"y":1.0126368823690595},{"x":309,"y":1.012819756970953},{"x":21,"y":1.0010242906779978},{"x":31,"y":1.0006536953945382},{"x":113,"y":1.0065770005750456},{"x":32,"y":1.0010840284594513},{"x":136,"y":1.0096591151380687},{"x":139,"y":1.009036334128617},{"x":174,"y":1.0113727341183498},{"x":331,"y":1.0142472841409846},{"x":363,"y":1.0138661845926082},{"x":284,"y":1.012420705241883},{"x":208,"y":1.0128709988734927},{"x":305,"y":1.0123181803204793},{"x":182,"y":1.0119951749441718},{"x":256,"y":1.0115529305495083},{"x":214,"y":1.0125666454554043},{"x":193,"y":1.0125658365470762},{"x":241,"y":1.0124651478650601},{"x":314,"y":1.0128973130184336},{"x":226,"y":1.0120032998855835},{"x":235,"y":1.011744775918763},{"x":262,"y":1.010882509527302},{"x":263,"y":1.0107259095271726},{"x":304,"y":1.012204802473306},{"x":40,"y":1.0022067625095612},{"x":129,"y":1.0085836746020946},{"x":317,"y":1.0125072767744137},{"x":294,"y":1.0120686920463988},{"x":91,"y":1.005558077000348},{"x":364,"y":1.0140596336566505},{"x":341,"y":1.0148334216572834},{"x":117,"y":1.0079263278869515},{"x":172,"y":1.010861722846846},{"x":108,"y":1.006398180297276},{"x":156,"y":1.0111494649672106},{"x":358,"y":1.0140196767271497},{"x":308,"y":1.0125885679839235},{"x":223,"y":1.012261392762524},{"x":181,"y":1.0117452880634341},{"x":278,"y":1.0114484076322086},{"x":56,"y":1.0034609139536348},{"x":33,"y":1.0012518310621323},{"x":13,"y":1.0015091966714729},{"x":22,"y":1.000825320007266},{"x":257,"y":1.0115839600424104},{"x":338,"y":1.0143186561973692},{"x":168,"y":1.0108192745735662},{"x":347,"y":1.0135645820355776},{"x":90,"y":1.0053091186254202},{"x":237,"y":1.0124117113643452},{"x":292,"y":1.0120766071586471},{"x":109,"y":1.0060970115266898},{"x":216,"y":1.0119690329808215},{"x":191,"y":1.01272496387389},{"x":143,"y":1.0095557190593925},{"x":178,"y":1.0116224442309505},{"x":247,"y":1.0118508272548603},{"x":328,"y":1.0137514374753391},{"x":167,"y":1.010809038893529},{"x":36,"y":1.001897358842684},{"x":41,"y":1.0021675804791759},{"x":187,"y":1.012035512213836},{"x":195,"y":1.0126330394468426},{"x":316,"y":1.0125874366321712},{"x":303,"y":1.0121458623922193},{"x":310,"y":1.0130597286078191},{"x":118,"y":1.0081887887589158},{"x":150,"y":1.0091446269088113},{"x":313,"y":1.012842949299893},{"x":238,"y":1.0124150896996822},{"x":196,"y":1.012301353695956},{"x":162,"y":1.010633162524463},{"x":184,"y":1.011854700093581},{"x":219,"y":1.01171827301012},{"x":89,"y":1.0057211359564078},{"x":100,"y":1.0067970760186453},{"x":351,"y":1.0131616767664744},{"x":243,"y":1.012636401179844},{"x":131,"y":1.0084899511402974},{"x":122,"y":1.008887811587992},{"x":43,"y":1.0025510915168285},{"x":231,"y":1.011680520054874},{"x":61,"y":1.0034673665369749},{"x":29,"y":1.0004608418935461},{"x":151,"y":1.0094328025396517},{"x":348,"y":1.013561193769173},{"x":44,"y":1.0019894262785187},{"x":258,"y":1.0116847979902301},{"x":250,"y":1.0119372593685445},{"x":301,"y":1.0120250646354854},{"x":93,"y":1.0058125009302932},{"x":6,"y":1.0007930457193706},{"x":111,"y":1.0060930709722393},{"x":28,"y":1.0008388692452423},{"x":134,"y":1.009367407389453},{"x":64,"y":1.003653259734427},{"x":334,"y":1.0141274844293384},{"x":323,"y":1.0129915423847742},{"x":189,"y":1.012827484993507},{"x":280,"y":1.0118696630192985},{"x":198,"y":1.012495920787083},{"x":155,"y":1.01099490221213},{"x":295,"y":1.0122924308185728},{"x":248,"y":1.0116916987037075},{"x":285,"y":1.0123895182100424},{"x":227,"y":1.011790732428499},{"x":220,"y":1.0121672627085267},{"x":103,"y":1.0064271398794207},{"x":170,"y":1.0109155300770793},{"x":51,"y":1.0028208471098774},{"x":25,"y":1.0012833600779614},{"x":261,"y":1.0108075991616037},{"x":201,"y":1.0128395184011516},{"x":166,"y":1.0107400134010964},{"x":34,"y":1.0013210978525258},{"x":252,"y":1.0113849680362426},{"x":325,"y":1.0140176324202976},{"x":146,"y":1.0095622132707003},{"x":228,"y":1.0113867973814792},{"x":306,"y":1.0126164530400887},{"x":125,"y":1.0087811928011101},{"x":276,"y":1.01145195151798},{"x":340,"y":1.014618299978193},{"x":148,"y":1.0099749564223452},{"x":17,"y":1.0014456076371363},{"x":312,"y":1.0126870121646807},{"x":3,"y":1.0003688917682552},{"x":286,"y":1.0121440405070112},{"x":279,"y":1.0119362878997142},{"x":12,"y":1.0012710074254103},{"x":332,"y":1.0142291813012556},{"x":330,"y":1.01410080177021},{"x":152,"y":1.0098824612861326},{"x":342,"y":1.014653171269596},{"x":2,"y":1.0000098912063755},{"x":66,"y":1.00337580694521},{"x":236,"y":1.0122834933782705},{"x":142,"y":1.0094301046053389},{"x":359,"y":1.0135744281841006},{"x":107,"y":1.0062647583595743},{"x":23,"y":1.0010063778026121},{"x":230,"y":1.0116907763940486},{"x":47,"y":1.0017150607961571},{"x":180,"y":1.0119352805966517},{"x":158,"y":1.011533243983254},{"x":350,"y":1.013233289658561},{"x":35,"y":1.001626729968657},{"x":127,"y":1.0088666915873616},{"x":302,"y":1.0127957283512286},{"x":82,"y":1.0054642204658468},{"x":76,"y":1.0047331333376048},{"x":215,"y":1.0125206966258833},{"x":97,"y":1.0059951192585885},{"x":277,"y":1.011480230559323},{"x":19,"y":1.0011929720047148},{"x":335,"y":1.0137834187131434},{"x":57,"y":1.0035983387095155},{"x":202,"y":1.0128932870683216},{"x":68,"y":1.0038063051742698},{"x":200,"y":1.0126432799472562},{"x":11,"y":1.001204208238478},{"x":115,"y":1.007381410297762},{"x":339,"y":1.0145507501615543},{"x":337,"y":1.0141972061260829},{"x":255,"y":1.0113564525931857},{"x":9,"y":1.0007811642394508},{"x":145,"y":1.0097269309116925},{"x":5,"y":1.0006071552372398},{"x":244,"y":1.0122478693012167},{"x":289,"y":1.0118810029284184},{"x":112,"y":1.006339358527523},{"x":179,"y":1.011775348948383},{"x":344,"y":1.014164663220562},{"x":245,"y":1.0119641134180177},{"x":266,"y":1.0105549923393817},{"x":324,"y":1.0136455570777465},{"x":254,"y":1.0112711499319487},{"x":283,"y":1.0122648771696656},{"x":83,"y":1.0054532821824747},{"x":138,"y":1.0092689994858628},{"x":346,"y":1.013470283797467},{"x":14,"y":1.0014811991534134},{"x":265,"y":1.010559941262586},{"x":333,"y":1.014660767228279},{"x":326,"y":1.0139827041025529},{"x":45,"y":1.0021288872300393},{"x":53,"y":1.0027759283784723},{"x":78,"y":1.005142003874191},{"x":315,"y":1.012385713792244},{"x":132,"y":1.008949514278361},{"x":26,"y":1.0008823223296253},{"x":123,"y":1.0086126594807763},{"x":203,"y":1.0128228653297098},{"x":140,"y":1.00947485294717},{"x":321,"y":1.0121716473344038},{"x":268,"y":1.0108914478060547},{"x":16,"y":1.0010150426895923},{"x":320,"y":1.0122917149541024},{"x":133,"y":1.0090956147682175},{"x":288,"y":1.011820787433709},{"x":163,"y":1.0104363857124898},{"x":81,"y":1.005287750201403},{"x":120,"y":1.0089879357026812},{"x":79,"y":1.0052857552464225},{"x":211,"y":1.0129845498592924},{"x":38,"y":1.0017275010329358},{"x":173,"y":1.0110264391686046},{"x":126,"y":1.0088468767615333},{"x":98,"y":1.0061327030830831},{"x":124,"y":1.0082511955377875},{"x":171,"y":1.0109073721587216},{"x":87,"y":1.0057459184223048},{"x":169,"y":1.0106963680902474},{"x":160,"y":1.0112035323826338},{"x":30,"y":1.0006562155293346},{"x":207,"y":1.0128472714323133},{"x":194,"y":1.0127441183895842},{"x":73,"y":1.0045751129363625},{"x":336,"y":1.0138816956792753},{"x":96,"y":1.0063209556335058},{"x":10,"y":1.001152182489386},{"x":272,"y":1.0106785118752597},{"x":270,"y":1.0101156837890988},{"x":271,"y":1.0104991584247065},{"x":18,"y":1.0012996308117186},{"x":105,"y":1.006463566297946},{"x":185,"y":1.0122293422830362},{"x":52,"y":1.0032404494474751},{"x":114,"y":1.0071048662487616},{"x":253,"y":1.011412740367749},{"x":209,"y":1.0127235551888998},{"x":147,"y":1.0099933438767155},{"x":67,"y":1.0034624906381944},{"x":296,"y":1.0126169847907134},{"x":318,"y":1.012512300403003},{"x":161,"y":1.0106975406160394},{"x":71,"y":1.0047678606990489},{"x":42,"y":1.002597074154393},{"x":80,"y":1.005299760864851},{"x":199,"y":1.0124300754291875},{"x":37,"y":1.0016764815814108},{"x":183,"y":1.0120254661300185},{"x":63,"y":1.003492199487529},{"x":212,"y":1.0125791963062736},{"x":94,"y":1.0060602037921142},{"x":362,"y":1.0136986162449566},{"x":8,"y":1.0008897000250883},{"x":246,"y":1.0118144365439863},{"x":190,"y":1.0128890095711995},{"x":177,"y":1.011600004771923},{"x":49,"y":1.002182256252456},{"x":84,"y":1.0053563338061038}]}],"marks":[{"type":"symbol","from":{"data":"0fb9d789-0807-4e7b-bd12-0482c7f41dcf"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"fill":{"value":"steelblue"},"fillOpacity":{"value":1}},"update":{"shape":"circle","size":{"value":70},"stroke":{"value":"transparent"}},"hover":{"size":{"value":210},"stroke":{"value":"white"}}}}],"scales":[{"name":"x","type":"linear","range":"width","zero":false,"domain":{"data":"0fb9d789-0807-4e7b-bd12-0482c7f41dcf","field":"data.x"}},{"name":"y","type":"linear","range":"height","nice":true,"zero":false,"domain":{"data":"0fb9d789-0807-4e7b-bd12-0482c7f41dcf","field":"data.y"}}],"axes":[{"type":"x","scale":"x"},{"type":"y","scale":"y"}]},"value":"#gorilla_repl.vega.VegaView{:content {:width 400, :height 247.2188, :padding {:top 10, :left 55, :bottom 40, :right 10}, :data [{:name \"0fb9d789-0807-4e7b-bd12-0482c7f41dcf\", :values ({:x 357, :y 1.0136907423120647} {:x 275, :y 1.0109739388893546} {:x 291, :y 1.012247192269331} {:x 249, :y 1.011470039603879} {:x 299, :y 1.0125176443565784} {:x 121, :y 1.0090845440190959} {:x 287, :y 1.0117767812158285} {:x 65, :y 1.0035384338216526} {:x 70, :y 1.0045044917524417} {:x 218, :y 1.0118911326014375} {:x 62, :y 1.0033677256823594} {:x 74, :y 1.0049327483522588} {:x 164, :y 1.0105253146113304} {:x 282, :y 1.0124991541327375} {:x 273, :y 1.0109683894428407} {:x 186, :y 1.0121499108779688} {:x 233, :y 1.0112977119207571} {:x 298, :y 1.0125680516294584} {:x 188, :y 1.012298645151612} {:x 240, :y 1.0127075951425013} {:x 110, :y 1.0062681658297592} {:x 130, :y 1.0085532731626599} {:x 311, :y 1.0128606903426431} {:x 128, :y 1.0088951016338485} {:x 259, :y 1.011553909273812} {:x 210, :y 1.013014958893747} {:x 229, :y 1.0112707062257367} {:x 153, :y 1.010430226772156} {:x 213, :y 1.0129679536236516} {:x 343, :y 1.0145187750849696} {:x 7, :y 1.0009797236341575} {:x 59, :y 1.003045964477863} {:x 86, :y 1.0052930955595323} {:x 154, :y 1.0109237794701857} {:x 20, :y 1.0011160087028748} {:x 224, :y 1.0122206357551566} {:x 355, :y 1.0136042902454512} {:x 72, :y 1.0046601021816983} {:x 58, :y 1.0035524236683415} {:x 205, :y 1.0128765306274987} {:x 60, :y 1.0029844084543824} {:x 175, :y 1.0114079032864252} {:x 322, :y 1.0125993323085456} {:x 27, :y 1.0008877113784558} {:x 352, :y 1.013329528722753} {:x 1, :y 1.0} {:x 69, :y 1.004065910362867} {:x 101, :y 1.0066972096014213} {:x 24, :y 1.0008041319869407} {:x 102, :y 1.0067665751609347} {:x 135, :y 1.0096504696163675} {:x 354, :y 1.0132099472220142} {:x 360, :y 1.0138842841583016} {:x 55, :y 1.0031533387700833} {:x 269, :y 1.0102718603305723} {:x 206, :y 1.012975206006562} {:x 165, :y 1.0106151080357257} {:x 85, :y 1.0050753073101248} {:x 225, :y 1.0121642694520925} {:x 297, :y 1.0125959586708653} {:x 39, :y 1.0018379982185657} {:x 274, :y 1.0112505756077752} {:x 88, :y 1.0053834001523712} {:x 217, :y 1.011763748603023} {:x 46, :y 1.0020440692042396} {:x 149, :y 1.0095689166121349} {:x 239, :y 1.0124295500771876} {:x 157, :y 1.0110774233223854} {:x 345, :y 1.0137108160713786} {:x 300, :y 1.0123482892440585} {:x 4, :y 1.0005092270985778} {:x 204, :y 1.0127852125885566} {:x 77, :y 1.0049705275701424} {:x 106, :y 1.006318796303561} {:x 197, :y 1.0122315225072187} {:x 232, :y 1.0119345847462173} {:x 260, :y 1.01133603217036} {:x 267, :y 1.0107452924723312} {:x 119, :y 1.008312611885723} {:x 319, :y 1.0117878732654293} {:x 222, :y 1.0124923185165249} {:x 293, :y 1.0119955435543366} {:x 95, :y 1.0061931960729298} {:x 329, :y 1.0140989507521831} {:x 144, :y 1.0097039109139245} {:x 176, :y 1.011526295253916} {:x 349, :y 1.0130819921201866} {:x 192, :y 1.0120883295002254} {:x 54, :y 1.0028830663249202} {:x 92, :y 1.005560173925204} {:x 221, :y 1.0123102551807606} {:x 141, :y 1.0094777222868367} {:x 307, :y 1.0124332617355654} {:x 290, :y 1.0120255111431875} {:x 361, :y 1.013868727626491} {:x 264, :y 1.0108306285167414} {:x 137, :y 1.0096334609844997} {:x 356, :y 1.0140926582017333} {:x 327, :y 1.0134011989983716} {:x 234, :y 1.011642780194859} {:x 104, :y 1.0063803256994979} {:x 353, :y 1.013243871101066} {:x 15, :y 1.001537325336652} {:x 48, :y 1.0017554332461296} {:x 242, :y 1.0125174401990946} {:x 50, :y 1.0025375485865624} {:x 251, :y 1.0117134121643645} {:x 116, :y 1.0076881330214165} {:x 75, :y 1.0049013629911674} {:x 159, :y 1.011536902451242} {:x 99, :y 1.0063918245416845} {:x 281, :y 1.0126368823690595} {:x 309, :y 1.012819756970953} {:x 21, :y 1.0010242906779978} {:x 31, :y 1.0006536953945382} {:x 113, :y 1.0065770005750456} {:x 32, :y 1.0010840284594513} {:x 136, :y 1.0096591151380687} {:x 139, :y 1.009036334128617} {:x 174, :y 1.0113727341183498} {:x 331, :y 1.0142472841409846} {:x 363, :y 1.0138661845926082} {:x 284, :y 1.012420705241883} {:x 208, :y 1.0128709988734927} {:x 305, :y 1.0123181803204793} {:x 182, :y 1.0119951749441718} {:x 256, :y 1.0115529305495083} {:x 214, :y 1.0125666454554043} {:x 193, :y 1.0125658365470762} {:x 241, :y 1.0124651478650601} {:x 314, :y 1.0128973130184336} {:x 226, :y 1.0120032998855835} {:x 235, :y 1.011744775918763} {:x 262, :y 1.010882509527302} {:x 263, :y 1.0107259095271726} {:x 304, :y 1.012204802473306} {:x 40, :y 1.0022067625095612} {:x 129, :y 1.0085836746020946} {:x 317, :y 1.0125072767744137} {:x 294, :y 1.0120686920463988} {:x 91, :y 1.005558077000348} {:x 364, :y 1.0140596336566505} {:x 341, :y 1.0148334216572834} {:x 117, :y 1.0079263278869515} {:x 172, :y 1.010861722846846} {:x 108, :y 1.006398180297276} {:x 156, :y 1.0111494649672106} {:x 358, :y 1.0140196767271497} {:x 308, :y 1.0125885679839235} {:x 223, :y 1.012261392762524} {:x 181, :y 1.0117452880634341} {:x 278, :y 1.0114484076322086} {:x 56, :y 1.0034609139536348} {:x 33, :y 1.0012518310621323} {:x 13, :y 1.0015091966714729} {:x 22, :y 1.000825320007266} {:x 257, :y 1.0115839600424104} {:x 338, :y 1.0143186561973692} {:x 168, :y 1.0108192745735662} {:x 347, :y 1.0135645820355776} {:x 90, :y 1.0053091186254202} {:x 237, :y 1.0124117113643452} {:x 292, :y 1.0120766071586471} {:x 109, :y 1.0060970115266898} {:x 216, :y 1.0119690329808215} {:x 191, :y 1.01272496387389} {:x 143, :y 1.0095557190593925} {:x 178, :y 1.0116224442309505} {:x 247, :y 1.0118508272548603} {:x 328, :y 1.0137514374753391} {:x 167, :y 1.010809038893529} {:x 36, :y 1.001897358842684} {:x 41, :y 1.0021675804791759} {:x 187, :y 1.012035512213836} {:x 195, :y 1.0126330394468426} {:x 316, :y 1.0125874366321712} {:x 303, :y 1.0121458623922193} {:x 310, :y 1.0130597286078191} {:x 118, :y 1.0081887887589158} {:x 150, :y 1.0091446269088113} {:x 313, :y 1.012842949299893} {:x 238, :y 1.0124150896996822} {:x 196, :y 1.012301353695956} {:x 162, :y 1.010633162524463} {:x 184, :y 1.011854700093581} {:x 219, :y 1.01171827301012} {:x 89, :y 1.0057211359564078} {:x 100, :y 1.0067970760186453} {:x 351, :y 1.0131616767664744} {:x 243, :y 1.012636401179844} {:x 131, :y 1.0084899511402974} {:x 122, :y 1.008887811587992} {:x 43, :y 1.0025510915168285} {:x 231, :y 1.011680520054874} {:x 61, :y 1.0034673665369749} {:x 29, :y 1.0004608418935461} {:x 151, :y 1.0094328025396517} {:x 348, :y 1.013561193769173} {:x 44, :y 1.0019894262785187} {:x 258, :y 1.0116847979902301} {:x 250, :y 1.0119372593685445} {:x 301, :y 1.0120250646354854} {:x 93, :y 1.0058125009302932} {:x 6, :y 1.0007930457193706} {:x 111, :y 1.0060930709722393} {:x 28, :y 1.0008388692452423} {:x 134, :y 1.009367407389453} {:x 64, :y 1.003653259734427} {:x 334, :y 1.0141274844293384} {:x 323, :y 1.0129915423847742} {:x 189, :y 1.012827484993507} {:x 280, :y 1.0118696630192985} {:x 198, :y 1.012495920787083} {:x 155, :y 1.01099490221213} {:x 295, :y 1.0122924308185728} {:x 248, :y 1.0116916987037075} {:x 285, :y 1.0123895182100424} {:x 227, :y 1.011790732428499} {:x 220, :y 1.0121672627085267} {:x 103, :y 1.0064271398794207} {:x 170, :y 1.0109155300770793} {:x 51, :y 1.0028208471098774} {:x 25, :y 1.0012833600779614} {:x 261, :y 1.0108075991616037} {:x 201, :y 1.0128395184011516} {:x 166, :y 1.0107400134010964} {:x 34, :y 1.0013210978525258} {:x 252, :y 1.0113849680362426} {:x 325, :y 1.0140176324202976} {:x 146, :y 1.0095622132707003} {:x 228, :y 1.0113867973814792} {:x 306, :y 1.0126164530400887} {:x 125, :y 1.0087811928011101} {:x 276, :y 1.01145195151798} {:x 340, :y 1.014618299978193} {:x 148, :y 1.0099749564223452} {:x 17, :y 1.0014456076371363} {:x 312, :y 1.0126870121646807} {:x 3, :y 1.0003688917682552} {:x 286, :y 1.0121440405070112} {:x 279, :y 1.0119362878997142} {:x 12, :y 1.0012710074254103} {:x 332, :y 1.0142291813012556} {:x 330, :y 1.01410080177021} {:x 152, :y 1.0098824612861326} {:x 342, :y 1.014653171269596} {:x 2, :y 1.0000098912063755} {:x 66, :y 1.00337580694521} {:x 236, :y 1.0122834933782705} {:x 142, :y 1.0094301046053389} {:x 359, :y 1.0135744281841006} {:x 107, :y 1.0062647583595743} {:x 23, :y 1.0010063778026121} {:x 230, :y 1.0116907763940486} {:x 47, :y 1.0017150607961571} {:x 180, :y 1.0119352805966517} {:x 158, :y 1.011533243983254} {:x 350, :y 1.013233289658561} {:x 35, :y 1.001626729968657} {:x 127, :y 1.0088666915873616} {:x 302, :y 1.0127957283512286} {:x 82, :y 1.0054642204658468} {:x 76, :y 1.0047331333376048} {:x 215, :y 1.0125206966258833} {:x 97, :y 1.0059951192585885} {:x 277, :y 1.011480230559323} {:x 19, :y 1.0011929720047148} {:x 335, :y 1.0137834187131434} {:x 57, :y 1.0035983387095155} {:x 202, :y 1.0128932870683216} {:x 68, :y 1.0038063051742698} {:x 200, :y 1.0126432799472562} {:x 11, :y 1.001204208238478} {:x 115, :y 1.007381410297762} {:x 339, :y 1.0145507501615543} {:x 337, :y 1.0141972061260829} {:x 255, :y 1.0113564525931857} {:x 9, :y 1.0007811642394508} {:x 145, :y 1.0097269309116925} {:x 5, :y 1.0006071552372398} {:x 244, :y 1.0122478693012167} {:x 289, :y 1.0118810029284184} {:x 112, :y 1.006339358527523} {:x 179, :y 1.011775348948383} {:x 344, :y 1.014164663220562} {:x 245, :y 1.0119641134180177} {:x 266, :y 1.0105549923393817} {:x 324, :y 1.0136455570777465} {:x 254, :y 1.0112711499319487} {:x 283, :y 1.0122648771696656} {:x 83, :y 1.0054532821824747} {:x 138, :y 1.0092689994858628} {:x 346, :y 1.013470283797467} {:x 14, :y 1.0014811991534134} {:x 265, :y 1.010559941262586} {:x 333, :y 1.014660767228279} {:x 326, :y 1.0139827041025529} {:x 45, :y 1.0021288872300393} {:x 53, :y 1.0027759283784723} {:x 78, :y 1.005142003874191} {:x 315, :y 1.012385713792244} {:x 132, :y 1.008949514278361} {:x 26, :y 1.0008823223296253} {:x 123, :y 1.0086126594807763} {:x 203, :y 1.0128228653297098} {:x 140, :y 1.00947485294717} {:x 321, :y 1.0121716473344038} {:x 268, :y 1.0108914478060547} {:x 16, :y 1.0010150426895923} {:x 320, :y 1.0122917149541024} {:x 133, :y 1.0090956147682175} {:x 288, :y 1.011820787433709} {:x 163, :y 1.0104363857124898} {:x 81, :y 1.005287750201403} {:x 120, :y 1.0089879357026812} {:x 79, :y 1.0052857552464225} {:x 211, :y 1.0129845498592924} {:x 38, :y 1.0017275010329358} {:x 173, :y 1.0110264391686046} {:x 126, :y 1.0088468767615333} {:x 98, :y 1.0061327030830831} {:x 124, :y 1.0082511955377875} {:x 171, :y 1.0109073721587216} {:x 87, :y 1.0057459184223048} {:x 169, :y 1.0106963680902474} {:x 160, :y 1.0112035323826338} {:x 30, :y 1.0006562155293346} {:x 207, :y 1.0128472714323133} {:x 194, :y 1.0127441183895842} {:x 73, :y 1.0045751129363625} {:x 336, :y 1.0138816956792753} {:x 96, :y 1.0063209556335058} {:x 10, :y 1.001152182489386} {:x 272, :y 1.0106785118752597} {:x 270, :y 1.0101156837890988} {:x 271, :y 1.0104991584247065} {:x 18, :y 1.0012996308117186} {:x 105, :y 1.006463566297946} {:x 185, :y 1.0122293422830362} {:x 52, :y 1.0032404494474751} {:x 114, :y 1.0071048662487616} {:x 253, :y 1.011412740367749} {:x 209, :y 1.0127235551888998} {:x 147, :y 1.0099933438767155} {:x 67, :y 1.0034624906381944} {:x 296, :y 1.0126169847907134} {:x 318, :y 1.012512300403003} {:x 161, :y 1.0106975406160394} {:x 71, :y 1.0047678606990489} {:x 42, :y 1.002597074154393} {:x 80, :y 1.005299760864851} {:x 199, :y 1.0124300754291875} {:x 37, :y 1.0016764815814108} {:x 183, :y 1.0120254661300185} {:x 63, :y 1.003492199487529} {:x 212, :y 1.0125791963062736} {:x 94, :y 1.0060602037921142} {:x 362, :y 1.0136986162449566} {:x 8, :y 1.0008897000250883} {:x 246, :y 1.0118144365439863} {:x 190, :y 1.0128890095711995} {:x 177, :y 1.011600004771923} {:x 49, :y 1.002182256252456} {:x 84, :y 1.0053563338061038})}], :marks [{:type \"symbol\", :from {:data \"0fb9d789-0807-4e7b-bd12-0482c7f41dcf\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :fill {:value \"steelblue\"}, :fillOpacity {:value 1}}, :update {:shape \"circle\", :size {:value 70}, :stroke {:value \"transparent\"}}, :hover {:size {:value 210}, :stroke {:value \"white\"}}}}], :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain {:data \"0fb9d789-0807-4e7b-bd12-0482c7f41dcf\", :field \"data.x\"}} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain {:data \"0fb9d789-0807-4e7b-bd12-0482c7f41dcf\", :field \"data.y\"}}], :axes [{:type \"x\", :scale \"x\"} {:type \"y\", :scale \"y\"}]}}"}
;; <=

;; @@
(defquery infer-growth 
  [returns]
  (let [yearly-growth (sample (normal 0.03 0.03))
        daily-growth (/ yearly-growth 365)
        volatility-dist (normal 1.0 (/ 0.1 365))]
    (reduce 
      (fn [yesterdays-return todays-return]
        (observe volatility-dist 
                 (/ todays-return
                    yesterdays-return
                    (+ 1.0 daily-growth)))
        todays-return)
      returns)
    yearly-growth))

(def samples
  (doquery :rmh infer-growth 
           [(:returns data)]))

(def results 
  (collect-results 
    (take 500 (drop 500 samples))))

(plot/list-plot (zipmap (:days data) 
                        (:returns data)))


(println "inferred growth: "
         (empirical-mean results)
         " +/- "
         (* 2 (empirical-std results)))

(println "true growth: "
         (:yearly-growth data))
;; @@
;; ->
;;; inferred growth:  0.014726903018743685  +/-  0.009601256149485714
;;; true growth:  0.016703190578758402
;;; 
;; <-
;; =>
;;; {"type":"html","content":"<span class='clj-nil'>nil</span>","value":"nil"}
;; <=
